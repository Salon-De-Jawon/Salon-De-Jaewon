<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragment/default}">

<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/master/shopEdit.css}">
    </th:block>
</head>

<body>
<div layout:fragment="main" id="main">
    <div class="section-container">
        <h3>ë§¤ì¥ ì •ë³´ ìˆ˜ì •</h3>

        <form id="shop-edit-form" th:action="@{/master/shop-edit/update}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" name="id" th:value="${shop.id}"/>

            <div class="customer-card">
                <div class="customer-header">
                    <strong>ë§¤ì¥ëª…</strong>
                    <input type="text" name="name" placeholder="ë§¤ì¥ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" th:value="${shop.name}" required />
                </div>

                <div class="customer-header">
                    <strong>ì—°ë½ì²˜</strong>
                    <input type="text" name="tel" placeholder="ì „í™”ë²ˆí˜¸ ì…ë ¥" th:value="${shop.tel}" />
                </div>

                <div class="customer-header">
                    <strong>ì£¼ì†Œ</strong>
                    <div class="address-wrapper">
                        <div class="address-row">
                            <input type="text" id="postcode" placeholder="ìš°í¸ë²ˆí˜¸" readonly>
                            <button type="button" class="btn-search-address" onclick="execDaumPostcode()">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button>
                        </div>
                        <input type="text" id="roadAddress" placeholder="ë„ë¡œëª…ì£¼ì†Œ" th:value="${shop.address}" readonly>
                        <div class="address-row">
                            <input type="text" id="detailAddress" name="addressDetail" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥"
                                   th:value="${shop.addressDetail}">
                            <input type="text" id="extraAddress" placeholder="ì°¸ê³ í•­ëª©" readonly>
                        </div>
                        <input type="hidden" name="latitude" th:value="${shop.latitude}" />
                        <input type="hidden" name="longitude" th:value="${shop.longitude}" />
                        <input type="hidden" name="address" id="fullAddress" th:value="${shop.address}" />
                    </div>
                </div>

                <div id="addressModal" class="modal">
                    <div class="modal-content">
                        <div id="daumWrap" style="width:100%;height:100%;"></div>
                    </div>
                </div>

                <div class="customer-header">
                    <strong>ìš´ì˜ì‹œê°„</strong>
                    <input type="time" name="openTime" th:value="${shop.openTime}" /> ~
                    <input type="time" name="closeTime" th:value="${shop.closeTime}" />
                </div>

                <div class="customer-header">
                    <strong>ì§€ê° ê¸°ì¤€ (ë¶„)</strong>
                    <input type="number" name="lateMin" min="0" th:value="${shop.lateMin}" />
                </div>

                <div class="customer-header">
                    <strong>ì¡°í‡´ ê¸°ì¤€ (ë¶„)</strong>
                    <input type="number" name="earlyLeaveMin" min="0" th:value="${shop.earlyLeaveMin}" />
                </div>

                <div class="customer-header">
                    <strong>ì˜ˆì•½ ê°„ê²© (ë¶„)</strong>
                    <input type="number" name="reservationInterval" min="10" step="5" th:value="${shop.reservationInterval}" />
                </div>

                <div class="customer-header">
                    <strong>ë§ˆê° ì „ ì˜ˆì•½ ì œí•œì‹œê°„ (ë¶„)</strong>
                    <input type="number" name="timeBeforeClosing" min="0" th:value="${shop.timeBeforeClosing}" />
                </div>

                <div class="customer-header">
                    <strong>íœ´ë¬´ ìš”ì¼</strong>
                    <select name="dayOff" th:value="${shop.dayOff}">
                        <option value="0" th:selected="${shop.dayOff == 0}">ì—†ìŒ</option>
                        <option value="1" th:selected="${shop.dayOff == 1}">ì›”ìš”ì¼</option>
                        <option value="2" th:selected="${shop.dayOff == 2}">í™”ìš”ì¼</option>
                        <option value="4" th:selected="${shop.dayOff == 4}">ìˆ˜ìš”ì¼</option>
                        <option value="8" th:selected="${shop.dayOff == 8}">ëª©ìš”ì¼</option>
                        <option value="16" th:selected="${shop.dayOff == 16}">ê¸ˆìš”ì¼</option>
                        <option value="32" th:selected="${shop.dayOff == 32}">í† ìš”ì¼</option>
                        <option value="64" th:selected="${shop.dayOff == 64}">ì¼ìš”ì¼</option>
                    </select>
                    <span style="font-size: 13px; color: #999;">â€» ì´ì§„ë²•ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</span>
                </div>

                <div class="customer-header">
                    <strong>ë§¤ì¥ ì†Œê°œ</strong>
                    <textarea name="description" placeholder="ë§¤ì¥ ì„¤ëª… ì…ë ¥"
                              th:text="${shop.description}"></textarea>
                </div>

                <div class="shop-image-upload">
                    <div class="shop-image-upload mb-3">
                        <input type="file" id="shopImageInput" multiple accept="image/*" style="display: none;" />
                        <button type="button" onclick="document.getElementById('shopImageInput').click()" class="custom-upload-label">ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ</button>
                    </div>
                    <div id="shopImagePreview" class="image-preview-container d-flex flex-wrap gap-2">
                    </div>
                </div>
            </div>

            <div style="text-align: right;">
                <button type="submit" class="btn-edit">ì €ì¥í•˜ê¸°</button>
            </div>
        </form>
    </div>
</div>

<th:block layout:fragment="script">
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0bcfa737cae58afd2f78fe737895ea3b&autoload=false&libraries=services"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        // ì „ì—­ì— ë¯¸ë¦¬ í•¨ìˆ˜ ì„ ì–¸
        window.execDaumPostcode = function () {
          alert('ì£¼ì†Œì°¾ê¸° í•¨ìˆ˜ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
        };

        let geocoder;

        // kakao.maps SDK ë¡œë“œ í›„ ì‹¤í–‰
        kakao.maps.load(function () {
          geocoder = new kakao.maps.services.Geocoder();

          // ì´ì œ execDaumPostcodeë¥¼ ì§„ì§œ í•¨ìˆ˜ë¡œ ë®ì–´ì“°ê¸°
          window.execDaumPostcode = function () {
            const modal = document.getElementById('addressModal');
            const daumWrap = document.getElementById('daumWrap');

            modal.style.display = 'block';

            new daum.Postcode({
              oncomplete: function(data) {
                let roadAddr = data.roadAddress;
                let extraAddr = '';

                if (data.bname !== '' && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)) {
                  extraAddr += data.bname;
                }
                if (data.buildingName !== '' && data.apartment === 'Y') {
                  extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                }

                document.getElementById("postcode").value = data.zonecode;
                document.getElementById("roadAddress").value = roadAddr;
                document.getElementById("extraAddress").value = extraAddr;
                document.getElementById("fullAddress").value =
                  roadAddr + " " + document.getElementById("detailAddress").value;

                // ì¢Œí‘œ ë³€í™˜
                geocoder.addressSearch(roadAddr, function(result, status) {
                  if (status === kakao.maps.services.Status.OK) {
                    const lat = result[0].y;
                    const lng = result[0].x;

                    document.querySelector('input[name="latitude"]').value = lat;
                    document.querySelector('input[name="longitude"]').value = lng;
                  } else {
                    console.error('ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨:', status);
                  }
                });

                // ì ì‹œ í›„ ëª¨ë‹¬ ë‹«ê¸°
                setTimeout(closeDaumPostcode, 100);
              },
              width: '100%',
              height: '100%'
            }).embed(daumWrap);
          };

          function closeDaumPostcode() {
            document.getElementById('addressModal').style.display = 'none';
            document.getElementById('daumWrap').innerHTML = "";
          }

          // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
          window.addEventListener("click", function(event) {
            const modal = document.getElementById('addressModal');
            if (event.target === modal) {
              closeDaumPostcode();
            }
          });

          // ìƒì„¸ì£¼ì†Œ ì…ë ¥ ì‹œ ì „ì²´ ì£¼ì†Œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
          const detailInput = document.getElementById("detailAddress");
          if (detailInput) {
            detailInput.addEventListener("input", function () {
              const road = document.getElementById("roadAddress").value;
              const detail = this.value;
              document.getElementById("fullAddress").value = road + " " + detail;
            });
          }
        });
    </script>

    <script th:inline="javascript">
        // images ë°°ì—´ì€ {id, originalName, imgName, imgUrl, isThumbnail, imgFile} ê°ì²´ë“¤ì„ ë‹´ìŠµë‹ˆë‹¤.
        // imgFileì€ ìƒˆ íŒŒì¼ì¸ ê²½ìš°ì—ë§Œ ì¡´ì¬í•©ë‹ˆë‹¤.
        let images = /*[[${shop.shopImages}]]*/ [];
        // ì‚­ì œëœ ê¸°ì¡´ ì´ë¯¸ì§€ IDë¥¼ ì¶”ì í•  ë°°ì—´ (ë°±ì—”ë“œì— deletedImageIdsë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì „ì†¡)
        let deletedImageIds = [];

        const previewContainer = document.getElementById("shopImagePreview");
        const fileInput = document.getElementById("shopImageInput");
        const shopEditForm = document.getElementById("shop-edit-form");

        /**
         * ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë Œë”ë§í•˜ê³  ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
         */
        function renderPreviews() {
            previewContainer.innerHTML = ""; // ê¸°ì¡´ ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”

            images.forEach((imgObj, idx) => {
                // deletedImageIdsì— í¬í•¨ëœ ì´ë¯¸ì§€ëŠ” ë Œë”ë§í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                // ì´ ì¡°ê±´ì€ ì´ë¯¸ì§€ê°€ images ë°°ì—´ì—ì„œ ì œê±°ë˜ì§€ ì•Šê³  deletedImageIdsì—ë§Œ ì¶”ê°€ëœ ê²½ìš°ì— ìœ íš¨í•©ë‹ˆë‹¤.
                // í˜„ì¬ ë¡œì§ì—ì„œëŠ” images ë°°ì—´ì—ì„œ spliceë¡œ ì œê±°í•˜ë¯€ë¡œ ì´ ê²€ì‚¬ëŠ” í•„ìˆ˜ëŠ” ì•„ë‹™ë‹ˆë‹¤.
                // í•˜ì§€ë§Œ í˜¹ì‹œ ëª¨ë¥¼ ìƒí™©ì„ ëŒ€ë¹„í•´ ë‚¨ê²¨ë‘˜ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                if (deletedImageIds.includes(imgObj.id)) return;

                const wrapper = document.createElement("div");
                wrapper.className = "preview-image-wrapper";

                const img = document.createElement("img");
                img.className = "preview-image";
                // ìƒˆ íŒŒì¼ì€ imgFile (Blob)ì—ì„œ URLì„ ìƒì„±í•˜ê³ , ê¸°ì¡´ íŒŒì¼ì€ imgUrlì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
                img.src = imgObj.imgUrl || (imgObj.imgFile ? URL.createObjectURL(imgObj.imgFile) : "");
                wrapper.appendChild(img);

                // ì¸ë„¤ì¼ ë¼ë””ì˜¤ ë²„íŠ¼
                const radio = document.createElement("input");
                radio.type = "radio";
                radio.name = "shopImagesThumbnail"; // ëª¨ë“  ë¼ë””ì˜¤ ë²„íŠ¼ì´ ë™ì¼í•œ nameì„ ê°€ì ¸ì•¼ ê·¸ë£¹ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.
                radio.className = "thumbnail-radio";
                radio.checked = imgObj.isThumbnail || false; // í˜„ì¬ ì´ë¯¸ì§€ì˜ ì¸ë„¤ì¼ ì—¬ë¶€
                radio.addEventListener("change", () => {
                    // ëª¨ë“  ì´ë¯¸ì§€ì˜ isThumbnailì„ falseë¡œ ì„¤ì •í•˜ê³ , í˜„ì¬ ì„ íƒëœ ì´ë¯¸ì§€ë§Œ trueë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
                    images.forEach((i) => i.isThumbnail = false); // ì´ ë¼ë””ì˜¤ ê·¸ë£¹ì˜ ëª¨ë“  ì¸ë„¤ì¼ í•´ì œ
                    imgObj.isThumbnail = true; // í˜„ì¬ ì´ë¯¸ì§€ ì¸ë„¤ì¼ ì„¤ì •
                    renderPreviews(); // ìƒíƒœ ë³€ê²½ í›„ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
                });
                wrapper.appendChild(radio);

                // ì‚­ì œ ë²„íŠ¼
                const delBtn = document.createElement("button");
                delBtn.type = "button";
                delBtn.className = "btn-delete-img";
                delBtn.innerText = "X";
                delBtn.addEventListener("click", () => {
                    if (confirm("ì´ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        if (imgObj.id) { // IDê°€ ìˆë‹¤ë©´ ê¸°ì¡´ ì´ë¯¸ì§€ì¸ ê²½ìš°
                            deletedImageIds.push(imgObj.id); // ì‚­ì œí•  ID ëª©ë¡ì— ì¶”ê°€
                        } else { // IDê°€ ì—†ë‹¤ë©´ ìƒˆ íŒŒì¼ì¸ ê²½ìš° (ì•„ì§ ì—…ë¡œë“œ ì•ˆ ë¨)
                            // ìƒˆ íŒŒì¼ì˜ ê²½ìš° Blob URL í•´ì œí•˜ì—¬ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€
                            if (imgObj.imgFile) URL.revokeObjectURL(img.src);
                        }
                        images.splice(idx, 1); // images ë°°ì—´ì—ì„œ í•´ë‹¹ ì´ë¯¸ì§€ ì œê±° (í™”ë©´ì—ì„œë„ ì‚¬ë¼ì§)
                        renderPreviews(); // ë¯¸ë¦¬ë³´ê¸° ë‹¤ì‹œ ë Œë”ë§
                    }
                });
                wrapper.appendChild(delBtn);

                previewContainer.appendChild(wrapper);
            });
        }


        // íŒŒì¼ ì…ë ¥ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        fileInput.addEventListener("change", (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                images.push({
                    id: null, // ìƒˆ íŒŒì¼ì´ë¯€ë¡œ IDëŠ” null
                    originalName: file.name,
                    imgName: "", // ë°±ì—”ë“œì—ì„œ ì„¤ì •ë  ì˜ˆì •
                    imgUrl: "",  // ë°±ì—”ë“œì—ì„œ ì„¤ì •ë  ì˜ˆì •
                    isThumbnail: false,
                    imgFile: file // ì‹¤ì œ File ê°ì²´
                });
            });
            // ìƒˆ íŒŒì¼ì´ ì¶”ê°€ë˜ì—ˆìœ¼ë‹ˆ ì¸ë„¤ì¼ ìƒíƒœê°€ ì œëŒ€ë¡œ ë°˜ì˜ë˜ë„ë¡ ë‹¤ì‹œ ë Œë”ë§
            // ë§Œì•½ ê¸°ì¡´ ì¸ë„¤ì¼ì´ ì—†ê³ , ì¶”ê°€ëœ ì´ë¯¸ì§€ê°€ í•˜ë‚˜ë¼ë©´ ì²« ì´ë¯¸ì§€ë¥¼ ì¸ë„¤ì¼ë¡œ ì„¤ì •
            if (images.length === files.length && images.length === 1) { // ì¶”ê°€ëœ íŒŒì¼ì´ ì²˜ìŒ íŒŒì¼ì´ê³  1ê°œì¼ë•Œ
                images[0].isThumbnail = true;
            } else if (!images.some(img => img.isThumbnail)) { // ì¸ë„¤ì¼ì´ ì•„ì§ ì§€ì •ë˜ì§€ ì•Šì•˜ë‹¤ë©´
                 if (images.length > 0) images[0].isThumbnail = true;
            }
            renderPreviews();
            fileInput.value = ""; // íŒŒì¼ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        });

        // ì´ˆê¸° ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
        // ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ìˆë‹¤ë©´ ì²« ì´ë¯¸ì§€ë¥¼ ì¸ë„¤ì¼ë¡œ ì„¤ì • (ì¸ë„¤ì¼ì´ ì—†ëŠ” ê²½ìš°)
        if (images.length > 0 && !images.some(img => img.isThumbnail)) {
            images[0].isThumbnail = true;
        }
        renderPreviews();


        // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (fetch API ì‚¬ìš©)
        shopEditForm.addEventListener("submit", async function(event) {
            event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë™ì‘ ë°©ì§€

            const formData = new FormData();

            // 1. CSRF í† í°ì„ í¼ì—ì„œ ê°€ì ¸ì™€ FormDataì— ì¶”ê°€
            const csrfTokenInput = this.querySelector('input[name="_csrf"]');
            if (csrfTokenInput) {
                const csrfToken = csrfTokenInput.value;
                formData.append("_csrf", csrfToken); // Spring Securityê°€ ê¸°ëŒ€í•˜ëŠ” ì´ë¦„ (_csrf)
            } else {
                console.error("CSRF í† í° inputì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
                alert("ë³´ì•ˆ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
                return; // í† í°ì´ ì—†ìœ¼ë©´ ì œì¶œ ì¤‘ë‹¨
            }

            // 2. ë§¤ì¥ ID ì¶”ê°€
            const shopId = this.querySelector('input[name="id"]').value;
            formData.append("id", shopId);

            // 3. ê¸°íƒ€ ì¼ë°˜ í¼ í•„ë“œ ì¶”ê°€
            const formElements = shopEditForm.querySelectorAll('input, select, textarea');
            formElements.forEach(element => {
                // CSRF í† í°, ë§¤ì¥ ID, íŒŒì¼ ì…ë ¥, ë¼ë””ì˜¤ ë²„íŠ¼(ì¸ë„¤ì¼ ì²˜ë¦¬)ì€ ë³„ë„ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ ê±´ë„ˆëœë‹ˆë‹¤.
                // shopImagesThumbnail ë¼ë””ì˜¤ ë²„íŠ¼ì˜ nameì€ ì¤‘ë³µë˜ë¯€ë¡œ ì§ì ‘ì ìœ¼ë¡œ FormDataì— ë„£ì§€ ì•ŠìŠµë‹ˆë‹¤.
                if (element.name && element.name !== '_csrf' && element.name !== 'id' && element.type !== 'file' && element.type !== 'radio' && element.name !== 'shopImagesThumbnail') {
                    formData.append(element.name, element.value);
                }
            });

            // 4. ì´ë¯¸ì§€ ë°ì´í„° ì¶”ê°€
            images.forEach((imgObj, idx) => {
                if (imgObj.imgFile) { // File ê°ì²´ê°€ ìˆë‹¤ë©´ (ìƒˆë¡œìš´ íŒŒì¼)
                    formData.append(`shopImages[${idx}].imgFile`, imgObj.imgFile);
                    // DTOì— 'isNew' í•„ë“œê°€ ì—†ìœ¼ë¯€ë¡œ, ë°±ì—”ë“œì—ì„œ imgFileì˜ ì¡´ì¬ ì—¬ë¶€ë¡œ ìƒˆ íŒŒì¼ì„ì„ íŒë‹¨í•©ë‹ˆë‹¤.
                } else if (imgObj.id) { // IDê°€ ìˆë‹¤ë©´ (ê¸°ì¡´ íŒŒì¼)
                    formData.append(`shopImages[${idx}].id`, imgObj.id);
                    formData.append(`shopImages[${idx}].originalName`, imgObj.originalName);
                    formData.append(`shopImages[${idx}].imgName`, imgObj.imgName);
                    formData.append(`shopImages[${idx}].imgUrl`, imgObj.imgUrl);
                }
                // ì¸ë„¤ì¼ ì—¬ë¶€ëŠ” í•­ìƒ ì „ì†¡ (ìƒˆ ì´ë¯¸ì§€ë“  ê¸°ì¡´ ì´ë¯¸ì§€ë“ )
                formData.append(`shopImages[${idx}].isThumbnail`, imgObj.isThumbnail ? "true" : "false");
            });

            // 5. ì‚­ì œëœ ì´ë¯¸ì§€ ID ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
            deletedImageIds.forEach((id, idx) => {
                // deletedImageIdsë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë°°ì—´ í˜•íƒœë¡œ ì „ì†¡ (ë°±ì—”ë“œ @RequestParamìœ¼ë¡œ ë°›ê¸° ìœ„í•¨)
                formData.append(`deletedImageIds[${idx}]`, id);
            });

            try {
                const response = await fetch(shopEditForm.action, {
                    method: 'POST',
                    body: formData,
                    // FormDataë¥¼ ì‚¬ìš©í•˜ë©´ Content-Type í—¤ë”ëŠ” ìë™ìœ¼ë¡œ 'multipart/form-data'ë¡œ ì„¤ì •ë©ë‹ˆë‹¤.
                    // ë”°ë¼ì„œ ì´ê³³ì— 'Content-Type' í—¤ë”ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.
                });

                if (response.ok) {
                    alert("ë§¤ì¥ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    window.location.href = "/master"; // ì„±ê³µ ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                } else {
                    const errorText = await response.text();
                    console.error("í¼ ì œì¶œ ì‹¤íŒ¨:", response.status, errorText);
                    alert(`ë§¤ì¥ ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: ${response.status} - ${errorText.substring(0, 150)}`); // ì˜¤ë¥˜ ë©”ì‹œì§€ ì¼ë¶€ í‘œì‹œ
                }
            } catch (error) {
                console.error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", error);
                alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
        });

    </script>
</th:block>

</body>
</html>