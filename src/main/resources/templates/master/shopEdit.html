<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragment/default}">

<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/master/shopEdit.css}">
    </th:block>
</head>

<body>
<div layout:fragment="main" id="main">
    <div class="section-container">
        <h3>ë§¤ì¥ ì •ë³´ ìˆ˜ì •</h3>

        <form id="shop-edit-form" th:action="@{/master/shop-edit/update}" method="post" enctype="multipart/form-data">
            <input type="hidden" name="id" th:value="${shop.id}"/>

            <div class="customer-card">

                <div class="customer-header">
                    <strong>ë§¤ì¥ëª…</strong>
                    <input type="text" name="name" placeholder="ë§¤ì¥ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" th:value="${shop.name}" required />
                </div>

                <div class="customer-header">
                    <strong>ì—°ë½ì²˜</strong>
                    <input type="text" name="tel" placeholder="ì „í™”ë²ˆí˜¸ ì…ë ¥" th:value="${shop.tel}" />
                </div>

                <div class="customer-header">
                    <strong>ì£¼ì†Œ</strong>
                    <div class="address-wrapper">
                        <div class="address-row">
                            <input type="text" id="postcode" placeholder="ìš°í¸ë²ˆí˜¸" readonly>
                            <button type="button" class="btn-search-address" onclick="execDaumPostcode()">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button>
                        </div>

                        <input type="text" id="roadAddress" placeholder="ë„ë¡œëª…ì£¼ì†Œ" th:value="${shop.address}" readonly>

                        <div class="address-row">
                            <input type="text" id="detailAddress" name="addressDetail" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥"
                                   th:value="${shop.addressDetail}">
                            <input type="text" id="extraAddress" placeholder="ì°¸ê³ í•­ëª©" readonly>
                        </div>
                        <input type="hidden" name="latitude" th:value="${shop.latitude}" />
                        <input type="hidden" name="longitude" th:value="${shop.longitude}" />
                        <input type="hidden" name="address" id="fullAddress" th:value="${shop.address}" />
                    </div>
                </div>

                <div id="addressModal" class="modal">
                    <div class="modal-content">
                        <div id="daumWrap" style="width:100%;height:100%;"></div>
                    </div>
                </div>

                <div class="customer-header">
                    <strong>ìš´ì˜ì‹œê°„</strong>
                    <input type="time" name="openTime" th:value="${shop.openTime}" /> ~
                    <input type="time" name="closeTime" th:value="${shop.closeTime}" />
                </div>

                <div class="customer-header">
                    <strong>ì§€ê° ê¸°ì¤€ (ë¶„)</strong>
                    <input type="number" name="lateMin" min="0" th:value="${shop.lateMin}" />
                </div>

                <div class="customer-header">
                    <strong>ì¡°í‡´ ê¸°ì¤€ (ë¶„)</strong>
                    <input type="number" name="earlyLeaveMin" min="0" th:value="${shop.earlyLeaveMin}" />
                </div>

                <div class="customer-header">
                    <strong>ì˜ˆì•½ ê°„ê²© (ë¶„)</strong>
                    <input type="number" name="reservationInterval" min="10" step="5" th:value="${shop.reservationInterval}" />
                </div>

                <div class="customer-header">
                    <strong>ë§ˆê° ì „ ì˜ˆì•½ ì œí•œì‹œê°„ (ë¶„)</strong>
                    <input type="number" name="timeBeforeClosing" min="0" th:value="${shop.timeBeforeClosing}" />
                </div>

                <div class="customer-header">
                    <strong>íœ´ë¬´ ìš”ì¼</strong>
                    <select name="dayOff" th:value="${shop.dayOff}">
                        <option value="0" th:selected="${shop.dayOff == 0}">ì—†ìŒ</option>
                        <option value="1" th:selected="${shop.dayOff == 1}">ì›”ìš”ì¼</option>
                        <option value="2" th:selected="${shop.dayOff == 2}">í™”ìš”ì¼</option>
                        <option value="4" th:selected="${shop.dayOff == 4}">ìˆ˜ìš”ì¼</option>
                        <option value="8" th:selected="${shop.dayOff == 8}">ëª©ìš”ì¼</option>
                        <option value="16" th:selected="${shop.dayOff == 16}">ê¸ˆìš”ì¼</option>
                        <option value="32" th:selected="${shop.dayOff == 32}">í† ìš”ì¼</option>
                        <option value="64" th:selected="${shop.dayOff == 64}">ì¼ìš”ì¼</option>
                    </select>
                    <span style="font-size: 13px; color: #999;">â€» ì´ì§„ë²•ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</span>
                </div>

                <div class="customer-header">
                    <strong>ë§¤ì¥ ì†Œê°œ</strong>
                    <textarea name="description" placeholder="ë§¤ì¥ ì„¤ëª… ì…ë ¥"
                              th:text="${shop.description}"></textarea>
                </div>

                <div class="shop-image-upload">
                    <label for="shopImageInput" class="custom-upload-label">
                        ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ
                    </label>
                    <!-- name="shopImages"ë¡œ ì§€ì •, multiple ì¶”ê°€ -->
                    <input type="file" id="shopImageInput" name="shopImages" multiple accept="image/*" />

                    <!-- ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
                    <div id="shopImagePreview" class="image-preview-container">
                        <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§ë¨ -->
                    </div>
                </div>


            </div>

            <div style="text-align: right;">
                <button type="submit" class="btn-edit">ì €ì¥í•˜ê¸°</button>
            </div>
        </form>
    </div>
</div>

<th:block layout:fragment="script">

    <!--  ì¹´ì¹´ì˜¤ ìš°í¸ì½”ë“œ ìŠ¤í¬ë¦½íŠ¸  -->
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0bcfa737cae58afd2f78fe737895ea3b&autoload=false&libraries=services"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        // ì „ì—­ì— ë¯¸ë¦¬ í•¨ìˆ˜ ì„ ì–¸
        window.execDaumPostcode = function () {
          alert('ì£¼ì†Œì°¾ê¸° í•¨ìˆ˜ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
        };

        let geocoder;

        // kakao.maps SDK ë¡œë“œ í›„ ì‹¤í–‰
        kakao.maps.load(function () {
          geocoder = new kakao.maps.services.Geocoder();

          // ì´ì œ execDaumPostcodeë¥¼ ì§„ì§œ í•¨ìˆ˜ë¡œ ë®ì–´ì“°ê¸°
          window.execDaumPostcode = function () {
            const modal = document.getElementById('addressModal');
            const daumWrap = document.getElementById('daumWrap');

            modal.style.display = 'block';

            new daum.Postcode({
              oncomplete: function(data) {
                let roadAddr = data.roadAddress;
                let extraAddr = '';

                if (data.bname !== '' && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)) {
                  extraAddr += data.bname;
                }
                if (data.buildingName !== '' && data.apartment === 'Y') {
                  extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                }

                document.getElementById("postcode").value = data.zonecode;
                document.getElementById("roadAddress").value = roadAddr;
                document.getElementById("extraAddress").value = extraAddr;
                document.getElementById("fullAddress").value =
                  roadAddr + " " + document.getElementById("detailAddress").value;

                // ì¢Œí‘œ ë³€í™˜
                geocoder.addressSearch(roadAddr, function(result, status) {
                  if (status === kakao.maps.services.Status.OK) {
                    const lat = result[0].y;
                    const lng = result[0].x;

                    document.querySelector('input[name="latitude"]').value = lat;
                    document.querySelector('input[name="longitude"]').value = lng;
                  } else {
                    console.error('ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨:', status);
                  }
                });

                // ì ì‹œ í›„ ëª¨ë‹¬ ë‹«ê¸°
                setTimeout(closeDaumPostcode, 100);
              },
              width: '100%',
              height: '100%'
            }).embed(daumWrap);
          };

          function closeDaumPostcode() {
            document.getElementById('addressModal').style.display = 'none';
            document.getElementById('daumWrap').innerHTML = "";
          }

          // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
          window.addEventListener("click", function(event) {
            const modal = document.getElementById('addressModal');
            if (event.target === modal) {
              closeDaumPostcode();
            }
          });

          // ìƒì„¸ì£¼ì†Œ ì…ë ¥ ì‹œ ì „ì²´ ì£¼ì†Œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
          const detailInput = document.getElementById("detailAddress");
          if (detailInput) {
            detailInput.addEventListener("input", function () {
              const road = document.getElementById("roadAddress").value;
              const detail = this.value;
              document.getElementById("fullAddress").value = road + " " + detail;
            });
          }
        });
    </script>

    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë° ì‚­ì œ
    <script>
        document.addEventListener("DOMContentLoaded", function () {
          const input = document.getElementById("shopImageInput");
          const preview = document.getElementById("shopImagePreview");

          input.addEventListener("change", function () {
            preview.innerHTML = ""; // ì´ˆê¸°í™”

            Array.from(input.files).forEach((file) => {
              const reader = new FileReader();
              reader.onload = function (e) {
                const wrapper = document.createElement("div");
                wrapper.className = "preview-image-wrapper";

                const img = document.createElement("img");
                img.src = e.target.result;

                const delBtn = document.createElement("button");
                delBtn.innerText = "ì‚­ì œ";
                delBtn.className = "btn-delete-img";
                delBtn.addEventListener("click", () => {
                  wrapper.remove();
                  input.value = "";
                });

                wrapper.appendChild(img);
                wrapper.appendChild(delBtn);
                preview.appendChild(wrapper);
              };
              reader.readAsDataURL(file);
            });
          });
        });
    </script>


</th:block>

</body>
</html>
